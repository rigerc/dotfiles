{{- /* Try to get BW_SESSION from chezmoi state first */ -}}
{{- $bwSession := "" -}}
{{- $bwSession = env "BW_SESSION" -}}
{{- if not $bwSession -}}
  {{- /* Try to read from temporary file */ -}}
  {{- $sessionFile := joinPath .chezmoi.workingTree ".tmp" "bw_session" -}}
  {{- if stat $sessionFile -}}
    {{- $bwSession = include $sessionFile | trim -}}
  {{- end -}}
{{- end -}}

{{- /* Export BW_SESSION if available */ -}}
{{- if $bwSession -}}
export BW_SESSION={{ $bwSession | quote }}
{{- end -}}

{{- $folderIdOutput := output "bw" "list" "folders" | fromJson -}}
{{- $folderId := "" -}}
{{- range $folderIdOutput -}}
  {{- if eq .name "Tokens" -}}
    {{- $folderId = .id -}}
  {{- end -}}
{{- end -}}
{{- if $folderId -}}
  {{- $tokensOutput := output "bw" "list" "items" "--folderid" $folderId | fromJson -}}
  {{- range $tokensOutput -}}
    {{- $tokenName := .name -}}
    {{- $fieldValue := "" -}}
    {{- if .fields -}}
      {{- range .fields -}}
        {{- if eq .name "Token" -}}
          {{- $fieldValue = .value -}}
        {{- end -}}
      {{- end -}}
    {{- end }}
export {{ $tokenName }}={{ $fieldValue | quote }}
  {{- end -}}
{{- end -}}