{{- $session := "" -}}
{{- $bwSessionPath := joinPath .chezmoi.homeDir ".bw_session" -}}
{{- if stat $bwSessionPath -}}
{{-   $session = include $bwSessionPath | trim -}}
{{- end -}}

{{- if $session -}}
{{- $folderIdOutput := output "bw" "--session" $session "list" "folders" | fromJson -}}
{{- $folderId := "" -}}
{{- range $folderIdOutput -}}
  {{- if eq .name "Tokens" -}}
    {{- $folderId = .id -}}
  {{- end -}}
{{- end -}}
{{- if $folderId -}}
  {{- $tokensOutput := output "bw" "--session" $session "list" "items" "--folderid" $folderId | fromJson -}}
  {{- range $tokensOutput -}}
    {{- $tokenName := .name -}}
    {{- $fieldValue := "" -}}
    {{- if .fields -}}
      {{- range .fields -}}
        {{- if eq .name "Token" -}}
          {{- $fieldValue = .value -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
export {{ $tokenName }}={{ $fieldValue | quote }}
  {{- end -}}
{{- end -}}
export ENV_SECRETS_IMPORTED="true"
{{- end -}}