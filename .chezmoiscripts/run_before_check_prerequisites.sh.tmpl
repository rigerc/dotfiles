#!{{ lookPath "bash" }}
set -uo pipefail

# Source shared utilities
if [[ -z "${CHEZMOI_WORKING_TREE}" ]]; then
    echo "Error, \$CHEZMOI_WORKING_TREE must be set. Please only run this script via chezmoi"
    exit 1
fi
source "${CHEZMOI_WORKING_TREE}/utils/common.sh"

# Check if gum is installed
if ! command -v gum >/dev/null 2>&1; then
    log_warning "gum is not installed. Attempting to install..."

    if is_arch; then
        log_info "Installing gum via pacman (Arch Linux)..."
        if install_pacman_package "gum"; then
            log_success "gum installed successfully"
        else
            log_warning "Failed to install gum via pacman, continuing anyway..."
        fi
    elif is_android; then
        log_info "Installing gum via pkg (Termux/Android)..."
        if install_termux_package "gum"; then
            log_success "gum installed successfully"
        else
            log_warning "Failed to install gum via pkg, continuing anyway..."
        fi
    else
        log_warning "Cannot determine system type or no supported package manager found for gum installation"
        log_info "Please install gum manually: https://github.com/charmbracelet/gum"
    fi
else
    log_success "gum is already installed"
fi

# Check if git is installed
if ! command -v git >/dev/null 2>&1; then
    log_warning "git is not installed. Attempting to install..."

    if is_arch; then
        log_info "Installing git via pacman (Arch Linux)..."
        if install_pacman_package "git"; then
            log_success "git installed successfully"
        else
            log_warning "Failed to install git via pacman, continuing anyway..."
        fi
    elif is_android; then
        log_info "Installing git via pkg (Termux/Android)..."
        if install_termux_package "git"; then
            log_success "git installed successfully"
        else
            log_warning "Failed to install git via pkg, continuing anyway..."
        fi
    else
        log_info "Installing git via system package manager..."
        if command_exists apt-get; then
            sudo apt-get update >/dev/null 2>&1
            if sudo apt-get install -y git >/dev/null 2>&1; then
                log_success "git installed successfully via apt"
            else
                log_warning "Failed to install git via apt, trying next..."
            fi
        elif command_exists yum; then
            if sudo yum install -y git >/dev/null 2>&1; then
                log_success "git installed successfully via yum"
            else
                log_warning "Failed to install git via yum, trying next..."
            fi
        elif command_exists dnf; then
            if sudo dnf install -y git >/dev/null 2>&1; then
                log_success "git installed successfully via dnf"
            else
                log_warning "Failed to install git via dnf, trying next..."
            fi
        elif command_exists brew; then
            if brew install git >/dev/null 2>&1; then
                log_success "git installed successfully via brew"
            else
                log_warning "Failed to install git via brew, continuing anyway..."
            fi
        else
            log_warning "Cannot determine system type or no supported package manager found for git installation"
            log_info "Please install git manually: https://git-scm.com/downloads"
        fi
    fi
else
    log_success "git is already installed"
fi

# Prerequisites fulfilled
log_success "Prerequisites fulfilled!"