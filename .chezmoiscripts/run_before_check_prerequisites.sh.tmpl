#!{{ lookPath "bash" }}
set -uo pipefail

# Source shared utilities
if [[ -z "${CHEZMOI_WORKING_TREE}" ]]; then
    echo "Error, \$CHEZMOI_WORKING_TREE must be set. Please only run this script via chezmoi"
    exit 1
fi
source "${CHEZMOI_WORKING_TREE}/.chezmoiscripts/common.sh"

log_header "Checking prerequisites"

# Check if gum is installed
if ! command -v gum >/dev/null 2>&1; then
    if ! install_system_package "gum"; then
        log_warning "gum installation failed, but continuing..."
    fi
fi

# Check if git is installed
if ! command -v git >/dev/null 2>&1; then
    if ! install_system_package "git"; then
        log_warning "git installation failed, but continuing..."
    fi
fi

# Check if bitwarden-cli is installed
if ! command -v bw >/dev/null 2>&1; then
    if ! install_system_package "bitwarden-cli"; then
        log_warning "bitwarden-cli installation failed, but continuing..."
    fi
fi

# Prerequisites fulfilled
log_success "Prerequisites fulfilled!"

if command_exists bw; then
    bw_login
fi