#!{{ lookPath "bash" }}
set -uo pipefail

# Source shared utilities
if [[ -z "${CHEZMOI_WORKING_TREE}" ]]; then
    echo "Error, \$CHEZMOI_WORKING_TREE must be set. Please only run this script via chezmoi"
    exit 1
fi
source "${CHEZMOI_WORKING_TREE}/utils/common.sh"

# Check if git is installed
if ! command -v git >/dev/null 2>&1; then
    log_warning "git is not installed or not in PATH"
    exit 1
fi

# Check if gum is installed
if ! command -v gum >/dev/null 2>&1; then
    log_warning "gum is not installed. Attempting to install..."

    if is_arch; then
        log_info "Installing gum via pacman (Arch Linux)..."
        if install_pacman_package "gum"; then
            log_success "gum installed successfully"
        else
            log_warning "Failed to install gum via pacman, continuing anyway..."
        fi
    elif is_android; then
        log_info "Installing gum via pkg (Termux/Android)..."
        if install_termux_package "gum"; then
            log_success "gum installed successfully"
        else
            log_warning "Failed to install gum via pkg, continuing anyway..."
        fi
    else
        log_warning "Cannot determine system type or no supported package manager found for gum installation"
        log_info "Please install gum manually: https://github.com/charmbracelet/gum"
    fi
else
    log_success "gum is already installed"
fi

# Prerequisites fulfilled
log_success "Prerequisites fulfilled!"