# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
# Initialization code that may require console input (password prompts, [y/n]
# confirmations, etc.) must go above this block; everything else may go below.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi


# Zsh configuration managed by chezmoi
# Place at ~/.local/share/chezmoi/dot_zshrc

# Zsh completion will be initialized after Zinit loads

# History configuration
HISTFILE=~/.zsh_history
HISTSIZE=10000
SAVEHIST=10000
setopt SHARE_HISTORY
setopt HIST_IGNORE_DUPS
setopt HIST_FIND_NO_DUPS

# Initialize zinit
ZINIT_HOME="${XDG_DATA_HOME:-${HOME}/.local/share}/zinit/zinit.git"
if [ ! -d "$ZINIT_HOME" ]; then
  mkdir -p "$(dirname $ZINIT_HOME)"
  git clone https://github.com/zdharma-continuum/zinit.git "$ZINIT_HOME"
fi
source "${ZINIT_HOME}/zinit.zsh"

# Load zinit plugins with optimized completion handling
zinit ice depth=1; zinit light romkatv/powerlevel10k
zinit light zdharma-continuum/fast-syntax-highlighting
zinit ice lucid wait='1' atload'_zsh_autosuggest_start'
zinit light zsh-users/zsh-autosuggestions
zinit ice lucid wait='1' atinit"source shell/key-bindings.zsh; source shell/completion.zsh"
zinit light junegunn/fzf
zinit ice lucid wait='1' blockf atload'zicompinit'
zinit light zsh-users/zsh-completions

# Powerlevel10k configuration
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh

# Fastfetch startup - show system info on shell start
if command -v fastfetch &> /dev/null; then
  fastfetch
fi

# Development tools
export PATH="$HOME/.cargo/bin:$PATH"
export PATH="/opt/homebrew/bin:$PATH"

# Eza (modern ls replacement) aliases
if command -v eza &> /dev/null; then
  alias ls="eza -la --git --icons"
  alias ll="eza -lh --git --icons"
  alias la="eza -la --git --icons"
  alias tree="eza --tree --git --icons"
else
  # Fallback to standard ls if eza is not available
  alias ls="ls -la"
  alias ll="ls -lh"
  alias la="ls -la"
fi

# Zoxide integration (if zoxide is installed)
if command -v zoxide &> /dev/null; then
  eval "$(zoxide init zsh --cmd cd)"

  # zoxide with fzf integration - interactive directory jumping
  if command -v fzf &> /dev/null; then
    # Function to use zoxide with fzf for interactive directory selection
    zif() {
      local dir
      dir=$(zoxide query -l | fzf --height 40% --reverse --prompt="cd> ")
      if [[ -n "$dir" ]]; then
        cd "$dir"
      fi
    }

    # Function to use zoxide with fzf for interactive directory selection with preview
    zif_preview() {
      local dir
      if command -v eza &> /dev/null; then
        dir=$(zoxide query -l | fzf --height 40% --reverse --prompt="cd> " --preview="eza -la --git --icons {}" --preview-window=right:30%)
      else
        dir=$(zoxide query -l | fzf --height 40% --reverse --prompt="cd> " --preview="ls -la {}" --preview-window=right:30%)
      fi
      if [[ -n "$dir" ]]; then
        cd "$dir"
      fi
    }
  fi
fi

# FZF integration (if fzf is installed)
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh


# Python virtual environment prompt
export VIRTUAL_ENV_DISABLE_PROMPT=1

# Load custom aliases
if [[ -f "$HOME/.config/zsh/aliases.zsh" ]]; then
    source "$HOME/.config/zsh/aliases.zsh"
fi

# Load tmux integration (auto-start tmux)
if [[ -f "$HOME/.config/zsh/tmux.zsh" ]]; then
    source "$HOME/.config/zsh/tmux.zsh"
fi

# Additional completion setup
autoload -Uz compinit && compinit -d ~/.cache/zcompdump